

local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

local PURPLE = Color3.fromHex("#8E54E9")
local PINK   = Color3.fromHex("#FF5FD2")
local BLUE   = Color3.fromHex("#4776E6")
local WHITE  = Color3.fromHex("#FFFFFF")

local DARK_BG1 = Color3.fromHex("#0D0B1E")
local DARK_BG2 = Color3.fromHex("#140F2E")
local MAIN_GRADIENT = WindUI:Gradient({
    ["0"]   = { Color = PURPLE, Transparency = 0 },
    ["50"]  = { Color = PINK,   Transparency = 0 },
    ["100"] = { Color = BLUE,   Transparency = 0 },
}, { Rotation = 45 })

local BACKGROUND_GRADIENT = WindUI:Gradient({
    ["0"]   = { Color = PURPLE, Transparency = 0.35 },
    ["50"]  = { Color = PINK,   Transparency = 0.35 },
    ["100"] = { Color = BLUE,   Transparency = 0.35 },
}, { Rotation = 45 })

local DARK_TAB_GRADIENT = WindUI:Gradient({
    ["0"]   = { Color = DARK_BG1, Transparency = 0 },
    ["100"] = { Color = DARK_BG2, Transparency = 0 },
}, { Rotation = 90 })


WindUI:AddTheme({
    Name = "ERROR HUBTheme",

    Accent = MAIN_GRADIENT,
    Hover  = MAIN_GRADIENT,

    Background = BACKGROUND_GRADIENT,
    BackgroundTransparency = 0.35,

    Outline = BLUE,
    Text = WHITE,
    Placeholder = Color3.fromHex("#E6DFFF"),
    Icon = WHITE,

    WindowBackground = BACKGROUND_GRADIENT,
    WindowShadow = Color3.fromRGB(0,0,0),

    -- TOPBAR
    WindowTopbarButtonIcon = WHITE,
    WindowTopbarTitle = WHITE,
    WindowTopbarAuthor = WHITE,
    WindowTopbarIcon = WHITE,

  
    TabBackground = DARK_TAB_GRADIENT,
    TabTitle = WHITE,
    TabIcon = WHITE,

    ElementBackground = DARK_TAB_GRADIENT,
    ElementTitle = WHITE,
    ElementDesc = Color3.fromHex("#E0D8FF"),
    ElementIcon = Color3.fromHex("#E0D8FF"),
    Button = MAIN_GRADIENT,
    Toggle = MAIN_GRADIENT,
    ToggleBar = WHITE,
    Checkbox = MAIN_GRADIENT,
    CheckboxIcon = WHITE,
    Slider = MAIN_GRADIENT,
    SliderThumb = WHITE,
    PopupBackground = BACKGROUND_GRADIENT,
    PopupBackgroundTransparency = 0.2,
    PopupTitle = WHITE,
    PopupContent = WHITE,
    PopupIcon = WHITE,

    DialogBackground = BACKGROUND_GRADIENT,
    DialogBackgroundTransparency = 0.2,
    DialogTitle = WHITE,
    DialogContent = WHITE,
    DialogIcon = WHITE,
})

WindUI:SetTheme("PurplePinkBlue")

local Window = WindUI:CreateWindow({
    Title = "ERROR HUB | Prison Life | Free",
    Icon = "rbxassetid://108455308252343", 
    Author = "Seesa",
    Folder = "ERROR HUB [ ALL Map ]",
    Size = UDim2.fromOffset(450, 330),
    Theme = "ERROR HUBTheme", 
    Transparent = true,
    Resizable = true,
})


local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local LP = Players.LocalPlayer
local Cam = workspace.CurrentCamera
local RS = game:GetService("RunService")


-- CONFIG
getgenv().SilentAimbot = false
getgenv().SAIM_FOV = 120
getgenv().SAIM_TEAM_LIST = {
    Neutral = true,
    Guards = false,
    Inmates = false,
    Criminals = false
}
local buffEnabled = false



-- DRAW FOV CIRCLE 
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 2
FOVCircle.Filled = false
FOVCircle.Color = Color3.fromRGB(255, 255, 255)
FOVCircle.Radius = getgenv().SAIM_FOV
FOVCircle.Visible = false

-- DRAW AIM LINE 
local AimLine = Drawing.new("Line")
AimLine.Thickness = 1.5
AimLine.Color = Color3.fromRGB(255, 0, 0)
AimLine.Visible = false

local function updateTeamsFromDropdown(selectedTeams)
    for teamName, _ in pairs(getgenv().SAIM_TEAM_LIST) do
        getgenv().SAIM_TEAM_LIST[teamName] = false
    end
    
    if type(selectedTeams) == "table" then
        for _, teamName in ipairs(selectedTeams) do
            if getgenv().SAIM_TEAM_LIST[teamName] ~= nil then
                getgenv().SAIM_TEAM_LIST[teamName] = true
            end
        end
    end
end

-- TEAM CHECK
local function isAllowedTeam(plr)
    if plr == LP then return false end
    
    for teamName, enabled in pairs(getgenv().SAIM_TEAM_LIST) do
        if enabled then
            local teamObj = Teams:FindFirstChild(teamName)
            if teamObj and plr.Team == teamObj then
                return true
            end
        end
    end
    
    if getgenv().SAIM_TEAM_LIST["Neutral"] and (not plr.Team or plr.Team.Name == "Neutral") then
        return true
    end
    
    return false
end

-- GET TARGET
local function getTarget()
    if not getgenv().SilentAimbot then return end
    
    local best, dist = nil, math.huge
    local cx, cy = Cam.ViewportSize.X/2, Cam.ViewportSize.Y/2
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LP and isAllowedTeam(player) and player.Character then
            local head = player.Character:FindFirstChild("Head")
            if head then
                local pos, vis = Cam:WorldToViewportPoint(head.Position)
                if vis then
                    local distance = math.sqrt((pos.X - cx)^2 + (pos.Y - cy)^2)
                    if distance <= getgenv().SAIM_FOV and distance < dist then
                        best = head
                        dist = distance
                    end
                end
            end
        end
    end
    
    return best
end

-- อัปเดต Visuals
RS.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Cam.ViewportSize.X/2, Cam.ViewportSize.Y/2)
    FOVCircle.Radius = getgenv().SAIM_FOV
    FOVCircle.Visible = getgenv().SilentAimbot
    
    if getgenv().SilentAimbot then
        local targetHead = getTarget()
        if targetHead then
            local screenPos, onScreen = Cam:WorldToViewportPoint(targetHead.Position)
            if onScreen then
                AimLine.From = Vector2.new(Cam.ViewportSize.X/2, Cam.ViewportSize.Y/2)
                AimLine.To = Vector2.new(screenPos.X, screenPos.Y)
                AimLine.Visible = true
            else
                AimLine.Visible = false
            end
        else
            AimLine.Visible = false
        end
    else
        AimLine.Visible = false
    end
end)

-- HOOK castRay
local castRay
for _, fn in ipairs(getgc(true)) do
    if typeof(fn) == "function" then
        for _, uv in ipairs(debug.getupvalues(fn)) do
            if typeof(uv) == "function" and debug.getinfo(uv).name == "castRay" then
                castRay = uv
                break
            end
        end
    end
    if castRay then break end
end

if castRay then
    local old
    old = hookfunction(castRay, function(a, b, ...)
        local t = getTarget()
        if t then
            return t, t.Position
        end
        return old(a, b, ...)
    end)
end


-- ----
-- ฟังชั่นบัพปืน
-- -------

local function BuffGun(tool)
    if not buffEnabled then return end
    if tool:IsA("Tool") then
        task.wait(0.1)
        tool:SetAttribute("AutoFire", true)
        tool:SetAttribute("FireRate", 0.001)
        tool:SetAttribute("Damage", 999)
        tool:SetAttribute("IsReloading", false)
    end
end

local function ClearBuff(tool)
    if tool:IsA("Tool") then
        task.wait(0.1)
        tool:SetAttribute("AutoFire", false)
        tool:SetAttribute("FireRate", nil)
        tool:SetAttribute("Damage", nil)
        tool:SetAttribute("IsReloading", nil)
    end
end

local function HandleBuffOnTool(tool)
    if buffEnabled then
        BuffGun(tool)
    else
        ClearBuff(tool)
    end
end

local function ConnectCharacter(char)
    char.ChildAdded:Connect(HandleBuffOnTool)
end

local Players = game:GetService("Players")
local plr = Players.LocalPlayer

plr.CharacterAdded:Connect(function(char)
    ConnectCharacter(char)
end)

if plr.Character then
    ConnectCharacter(plr.Character)
end

for _, tool in pairs(plr.Backpack:GetChildren()) do
    HandleBuffOnTool(tool)
end

plr.Backpack.ChildAdded:Connect(HandleBuffOnTool)


-- SERVICES
-- ===============================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- ===============================
-- SETTINGS
-- ===============================
local ESPSettings = {
    Enabled  = false,
    Name     = true,
    Distance = true,
    Health   = true
}

local TEXT_SIZE = 16

-- ===============================
-- STORAGE
-- ===============================
local ESP = {}

-- ===============================
-- HEALTH COLOR
-- ===============================
local function HealthColor(p)
    if p > 60 then
        return Color3.fromRGB(0,255,0)
    elseif p > 30 then
        return Color3.fromRGB(255,170,0)
    else
        return Color3.fromRGB(255,0,0)
    end
end

-- ===============================
-- UPDATE VISIBILITY
-- ===============================
local function updateAllESPVisibility()
    for _, d in pairs(ESP) do
        d.Name.Visible = false
        d.Distance.Visible = false
        d.Health.Visible = false
    end
end

-- ===============================
-- CREATE ESP
-- ===============================
local function CreateESP(player)
    if player == LocalPlayer then return end

    local nameText = Drawing.new("Text")
    nameText.Size = TEXT_SIZE
    nameText.Font = 2
    nameText.Outline = true
    nameText.Center = false
    nameText.Visible = false

    local distText = Drawing.new("Text")
    distText.Size = TEXT_SIZE
    distText.Font = 2
    distText.Outline = true
    distText.Center = false
    distText.Color = Color3.new(1,1,1)
    distText.Visible = false

    local hpText = Drawing.new("Text")
    hpText.Size = TEXT_SIZE
    hpText.Font = 2
    hpText.Outline = true
    hpText.Center = false
    hpText.Visible = false

    ESP[player] = {
        Name = nameText,
        Distance = distText,
        Health = hpText
    }
end

local function RemoveESP(player)
    if ESP[player] then
        ESP[player].Name:Remove()
        ESP[player].Distance:Remove()
        ESP[player].Health:Remove()
        ESP[player] = nil
    end
end

for _, p in pairs(Players:GetPlayers()) do
    CreateESP(p)
end
Players.PlayerAdded:Connect(CreateESP)
Players.PlayerRemoving:Connect(RemoveESP)

-- ===============================
-- RENDER LOOP
-- ===============================
RunService.RenderStepped:Connect(function()
    if not ESPSettings.Enabled then return end

    local myChar = LocalPlayer.Character
    local myHrp = myChar and myChar:FindFirstChild("HumanoidRootPart")
    if not myHrp then return end

    for player, data in pairs(ESP) do
        local char = player.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        local hum = char and char:FindFirstChildOfClass("Humanoid")

        if hrp and hum and hum.Health > 0 then
            local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                local baseX, baseY = pos.X, pos.Y - 30
                local offsetX = 0
                local dist = (myHrp.Position - hrp.Position).Magnitude

                -- NAME
                if ESPSettings.Name then
                    data.Name.Text = player.Name
                    data.Name.Color = (player.Team and player.Team.TeamColor)
                        and player.Team.TeamColor.Color or Color3.new(1,1,1)
                    data.Name.Position = Vector2.new(baseX, baseY)
                    data.Name.Visible = true
                    offsetX = data.Name.TextBounds.X
                else
                    data.Name.Visible = false
                end

                -- DISTANCE
                if ESPSettings.Distance then
                    data.Distance.Text = " | " .. math.floor(dist)
                    data.Distance.Position = Vector2.new(baseX + offsetX, baseY)
                    data.Distance.Visible = true
                    offsetX += data.Distance.TextBounds.X
                else
                    data.Distance.Visible = false
                end

                -- HEALTH
                if ESPSettings.Health then
                    local hp = math.floor((hum.Health / hum.MaxHealth) * 100)
                    data.Health.Text = " | " .. hp .. "%"
                    data.Health.Color = HealthColor(hp)
                    data.Health.Position = Vector2.new(baseX + offsetX, baseY)
                    data.Health.Visible = true
                else
                    data.Health.Visible = false
                end
            else
                data.Name.Visible = false
                data.Distance.Visible = false
                data.Health.Visible = false
            end
        else
            data.Name.Visible = false
            data.Distance.Visible = false
            data.Health.Visible = false
        end
    end
end)

-- ===============================
-- UI TOGGLES
-- ===============================


local Tab = Window:Tab({Title = "MAIN", Icon = "list"})

Tab:Toggle({
    Title = "Silent Aim",
    Desc = "ล็อคกระสุน",
    Icon = "target",
    Type = "Checkbox",
    Value = getgenv().SilentAimbot,
    Callback = function(state)
        getgenv().SilentAimbot = state
        FOVCircle.Visible = state
        AimLine.Visible = state
    end
})


Tab:Slider({
    Title = "FOV Size",
    Desc = "ปรับวง",
    Step = 1,
    Value = {
        Min = 50,
        Max = 500,
        Default = getgenv().SAIM_FOV,
    },
    Callback = function(value)
        getgenv().SAIM_FOV = value
    end
})


Tab:Dropdown({
    Title = "Search Teame lock",
    Desc = "เลือกทีมที่จะให้Silent aimมันล็อค",
    Values = { "Neutral", "Guards", "Inmates", "Criminals" },
    Value = { "Neutral" },
    Multi = true,
    AllowNone = false,
    Callback = function(selectedTeams)
        updateTeamsFromDropdown(selectedTeams)
    end
})


Tab:Toggle({
    Title = "Buff ปืน",
    Desc = "ทำให้ปืนยิงรัว",
    Value = false,
    Callback = function(v)
        buffEnabled = v
        
        for _, tool in pairs(plr.Backpack:GetChildren()) do
            HandleBuffOnTool(tool)
        end
        
        if plr.Character then
            for _, tool in pairs(plr.Character:GetChildren()) do
                HandleBuffOnTool(tool)
            end
        end
    end
})

local ESPTab = Window:Tab({Title = "ESP", Icon = "eye"})

ESPTab:Toggle({
    Title = "ESP Enable",
    Desc = "เปิด / ปิด ESP ทั้งหมด",
    Default = false,
    Callback = function(state)
        ESPSettings.Enabled = state
        updateAllESPVisibility()
    end
})

ESPTab:Toggle({
    Title = "ESP Name",
    Desc = "แสดงชื่อ",
    Default = true,
    Callback = function(state)
        ESPSettings.Name = state
        updateAllESPVisibility()
    end
})

ESPTab:Toggle({
    Title = "ESP Distance",
    Desc = "แสดงระยะ",
    Default = true,
    Callback = function(state)
        ESPSettings.Distance = state
        updateAllESPVisibility()
    end
})

ESPTab:Toggle({
    Title = "ESP Health",
    Desc = "แสดงเลือด (%)",
    Default = true,
    Callback = function(state)
        ESPSettings.Health = state
        updateAllESPVisibility()
    end
})
